---
title: "Regression on speed dating data"
author: "Jos√© Benardi de Souza Nunes"
date: 28/07/2018
output:
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    df_print: paged
    toc: yes
    toc_float: yes
---

```{r setup, echo=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ggfortify)
library(modelr)
library(GGally)
library(broom)
library(here)

theme_set(theme_bw())
```

# Data Overview

```{r}
data <- read_csv(here("data/speed-dating.csv"),
                 progress = FALSE,
                 col_types =cols(.default = col_integer(),
                                 int_corr = col_double(),
                                 field = col_character(),
                                 from = col_character(),
                                 career = col_character(),
                                 attr = col_double(),
                                 sinc = col_double(),
                                 intel = col_double(),
                                 fun = col_double(),
                                 amb = col_double(),
                                 shar = col_double(),
                                 like = col_double(),
                                 prob = col_double(),
                                 match_es = col_double(),
                                 attr3_s = col_double(),
                                 sinc3_s = col_double(),
                                 intel3_s = col_double(),
                                 fun3_s = col_double(),
                                 amb3_s = col_double())) %>%
  mutate( age_dif =abs(age - age_o))

data %>%
  glimpse()
```

```{r}
data %>%
  na.omit(race) %>%
  ggplot(aes(race, ..prop..)) +
  geom_bar()
```

* Most of the participants are white (code = 2)
* There were no native americans involved (code = 5) 

```{r}
require(GGally)

temp <- data %>% 
  select(like,fun,amb,attr,sinc,intel,shar,prob,
         fun3_s,amb3_s,attr3_s,sinc3_s,intel3_s) %>% 
    na.omit()

ggcorr(temp, palette = "RdBu", label = TRUE,
       hjust = 0.75, label_size = 3, nbreaks = 5) +
  ggtitle("Correlation plot for employed variables")
```

* What a person (p1) believes about herself/himself doesn't show promising results in terms of correlation
* Among what p1 thinks about p2 how *ambitious* p1 thinks p2 is shows the weakest correlation with how much p1 likes p2.
* Intelligence has interesting interactions with sincerity and ambition.

```{r}
temp <- data %>% 
  select(like,fun,attr,sinc,intel,shar,prob) %>% 
    na.omit()

ggpairs(temp, 
        upper = list(continuous = "density"), 
        lower = list(continuous = wrap("cor", size=5)),
        axisLabels = 'show',progress = F) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Regarding the relatinship with the response variable "**like**":

* Looking at the bidimensional density plot**fun** and **attr** have a cleaner and clearer connection with **like** as expected from what we saw in terms of correlation.
* Despite unpromising results in correlation **prob** has a somewhat clean interaction with **like** in terms of bidimensional density plot. Might be worth looking into.

```{r}
temp %>%
  ggplot(aes(fun, like)) +
   stat_density2d(aes(fill = ..level..), geom = "polygon")
```

* Intuition would suggest a positive interaction between being seen as fun and being liked, that interaction being of considerable magnitude.

```{r}
temp %>%
  ggplot(aes(attr, like)) +
   stat_density2d(aes(fill = ..level..), geom = "polygon")
```

* Intuition would suggest a positive interaction between being seen as attractive and being liked (no surprise there), that interaction being of considerable magnitude.

# Testing Regression Models

```{r}
temp %>% ## Put predictors on same scale
   mutate_at(.vars = vars(fun,attr,sinc,intel,shar),
             .funs = funs(scale(.))) -> temp

temp %>% 
  sample_n(10)
```

```{r}
t <- data %>% na.omit()
mod <- lm(like ~  fun + attr + shar + prob ,
          data = t)

glance(mod) 
``` 

```{r}
tibble::as_tibble(rownames = "coefficient",
                  confint(mod)) 
```

```{r}
tibble::as_tibble(rownames = "coefficient",
                  confint(mod)) %>%
  filter(coefficient != "(Intercept)") %>%
  ggplot(aes(coefficient,ymin = `2.5 %`, ymax = `97.5 %`)) +
  geom_errorbar() +
  geom_hline(yintercept = 0, colour = "darkorange")
```

## Residual Analysis

Let's keep the residue data in a specific dataframe

```{r}
mod.res <- resid(mod)
std.resid <- rstandard(mod)
like <- t$like

resid_data <- data.frame(mod.res,std.resid,like,
                       stringsAsFactors=FALSE)
resid_data %>% 
  sample_n(10)
```


```{r}
resid_data %>%
  ggplot(aes(like, mod.res)) +
  geom_point(alpha = 0.4) +
  geom_hline(yintercept = 0,
             color = "red") +
  labs(x = "Response Variable (like)", y = "Residue") +
  ggtitle("Residual Plot")
```

```{r}
mod %>%
  ggplot(aes(.fitted, .resid)) + 
  geom_point() +
  stat_smooth(method="loess") + 
  geom_hline(yintercept=0, col="red", linetype="dashed") + 
  xlab("Fitted values") + ylab("Residuals") + 
  ggtitle("Residual vs Fitted Plot")
```


```{r}
y <- quantile(resid_data$std.resid[!is.na(resid_data$std.resid)], c(0.25, 0.75))
x <- qnorm(c(0.25, 0.75))
slope <- diff(y)/diff(x)
int <- y[1L] - slope * x[1L]

t %>%
  ggplot(aes(sample=std.resid)) +
  stat_qq(shape=1, size=3) +      # open circles
  labs(title="Normal Q-Q",        # plot title
  x="Theoretical Quantiles",      # x-axis label
  y="Standardized Residuals") +   # y-axis label
  geom_abline(slope = slope,
              intercept = int,
              linetype="dashed")  # dashed reference line
```

```{r}
mod %>%
  ggplot(aes(.fitted, 
             sqrt(abs(.stdresid)))) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess",
              na.rm = TRUE) +
  labs(title = "Scale-Location",
       x= "Fitted Value",
       y = expression(sqrt("|Standardized residuals|")))
```

```{r}
mod %>%
  ggplot(aes(.hat, .stdresid)) + 
  geom_point(aes(size=.cooksd), na.rm=TRUE) +
  stat_smooth(method="loess", na.rm=TRUE) +
  xlab("Leverage")+ylab("Standardized Residuals") + 
  ggtitle("Residual vs Leverage Plot") + 
  scale_size_continuous("Cook's Distance", range=c(1,5)) +    
  theme(legend.position="bottom")
```

```{r}
mod %>%
  ggplot(aes(.hat, .cooksd)) + 
  geom_point(na.rm=TRUE) + 
  stat_smooth(method="loess", na.rm=TRUE) + 
  xlab("Leverage hii")+ylab("Cook's Distance") + 
  ggtitle("Cook's dist vs Leverage hii/(1-hii)") + 
  geom_abline(slope=seq(0,3,0.5), color="gray", linetype="dashed")
```

<!-- ```{r} -->
<!-- # library(rgl) -->
<!-- # with(temp,plot3d(like,shar,attr, col="blue", size=1, type="s", main="3D Quadratic Model Fit with Log of Income excl. Women^2")) -->


<!-- ``` -->

<!-- ## We gotta pump up those numbers -->

<!-- ```{r} -->
<!-- t <- data %>% na.omit() -->
<!-- mod <- lm(like ~ factor(from) * fun * prob * order +  -->
<!--             factor(from) * attr * prob * order +  -->
<!--             factor(from) * shar * prob * order +  -->
<!--             factor(from) * sinc * prob * order, data = t) -->
<!-- glance(mod)  -->
<!-- ```  -->
<!-- ```{r} -->
<!-- sqrt(mean(mod$residuals^2)) -->
<!-- ``` -->

<!-- ```{r} -->
<!-- autoplot(mod) -->
<!-- ``` -->



